<!DOCTYPE html>
<html>
<head>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      font-size: 14px;
      line-height: 1.5;
    }
    h2 {
      margin: 0 0 16px 0;
      font-size: 16px;
      font-weight: 600;
    }
    .upload-area {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 32px;
      text-align: center;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-area:hover {
      border-color: #0066FF;
      background: #f8f9fa;
    }
    .upload-area.dragover {
      border-color: #0066FF;
      background: #e6f2ff;
    }
    .upload-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      opacity: 0.5;
    }
    .upload-text {
      color: #333;
      font-weight: 500;
      margin-bottom: 4px;
    }
    .upload-hint {
      color: #666;
      font-size: 12px;
    }
    .file-info {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 16px;
      display: none;
    }
    .file-info.show {
      display: block;
    }
    .file-name {
      font-weight: 500;
      margin-bottom: 4px;
    }
    .file-size {
      font-size: 12px;
      color: #666;
    }
    input[type="file"] {
      display: none;
    }
    .button-group {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .button-primary {
      background: #0066FF;
      color: white;
    }
    .button-primary:hover:not(:disabled) {
      background: #0052CC;
    }
    .button-secondary {
      background: #f0f0f0;
      color: #333;
    }
    .button-secondary:hover {
      background: #e0e0e0;
    }
    .status {
      margin-top: 16px;
      padding: 12px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
    }
    .status.success {
      background: #e6f7ed;
      color: #0b5e34;
      display: block;
    }
    .status.error {
      background: #ffe6e6;
      color: #c00;
      display: block;
    }
    .status.loading {
      background: #e6f2ff;
      color: #0066FF;
      display: block;
    }
    .spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #0066FF;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h2>PSD to Figma Converter</h2>
  
  <div class="upload-area" id="uploadArea">
    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
      <polyline points="17 8 12 3 7 8"></polyline>
      <line x1="12" y1="3" x2="12" y2="15"></line>
    </svg>
    <div class="upload-text">Drop PSD file here or click to browse</div>
    <div class="upload-hint">Maximum file size: 100MB</div>
  </div>
  
  <input type="file" id="fileInput" accept=".psd" />
  
  <div class="file-info" id="fileInfo">
    <div class="file-name" id="fileName"></div>
    <div class="file-size" id="fileSize"></div>
  </div>
  
  <div class="button-group">
    <button class="button-primary" id="convertBtn" disabled>Convert to Figma</button>
    <button class="button-secondary" id="cancelBtn">Cancel</button>
  </div>
  
  <div id="status" class="status"></div>
  
  <script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const convertBtn = document.getElementById('convertBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const statusDiv = document.getElementById('status');
    
    let selectedFile = null;
    
    // Click to open file dialog
    uploadArea.onclick = () => fileInput.click();
    
    // Drag and drop handlers
    uploadArea.ondragover = (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    };
    
    uploadArea.ondragleave = () => {
      uploadArea.classList.remove('dragover');
    };
    
    uploadArea.ondrop = (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    };
    
    // File input change
    fileInput.onchange = (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    };
    
    function handleFile(file) {
      // Validate file type
      if (!file.name.toLowerCase().endsWith('.psd')) {
        showStatus('error', 'Please select a PSD file');
        return;
      }
      
      // Validate file size (100MB)
      if (file.size > 100 * 1024 * 1024) {
        showStatus('error', 'File is too large. Maximum size is 100MB');
        return;
      }
      
      selectedFile = file;
      
      // Show file info
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      fileInfo.classList.add('show');
      
      // Enable convert button
      convertBtn.disabled = false;
      
      // Clear any previous status
      statusDiv.style.display = 'none';
    }
    
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    convertBtn.onclick = async () => {
      if (!selectedFile) {
        showStatus('error', 'Please select a file first');
        return;
      }
      
      try {
        convertBtn.disabled = true;
        showStatus('loading', 'Uploading PSD file...');
        
        // Upload file to backend
        const formData = new FormData();
        formData.append('file', selectedFile);
        
        const uploadResponse = await fetch('http://localhost:3000/api/upload', {
          method: 'POST',
          body: formData
        });
        
        if (!uploadResponse.ok) {
          throw new Error(`Upload failed: ${uploadResponse.status}`);
        }
        
        const uploadData = await uploadResponse.json();
        const jobId = uploadData.jobId;
        
        showStatus('loading', 'Converting PSD to Figma format...');
        
        // Start conversion
        const convertResponse = await fetch('http://localhost:3000/api/convert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jobId })
        });
        
        if (!convertResponse.ok) {
          throw new Error(`Conversion failed: ${convertResponse.status}`);
        }
        
        // Poll for completion
        let attempts = 0;
        while (attempts < 60) {
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          const statusResponse = await fetch(`http://localhost:3000/api/status/${jobId}`);
          const statusData = await statusResponse.json();
          
          if (statusData.status === 'completed') {
            showStatus('loading', 'Creating nodes in Figma...');
            
            // Get the structure file
            const structureUrl = 'http://localhost:3000/uploads/figma-structure-latest.json';
            const structureResponse = await fetch(structureUrl);
            const structureData = await structureResponse.json();
            
            // Send to plugin code for rendering
            parent.postMessage({ 
              pluginMessage: { 
                type: 'import-nodes',
                data: {
                  nodes: structureData.nodes || [],
                  fileName: selectedFile.name.replace('.psd', '')
                }
              } 
            }, '*');
            
            return;
            
          } else if (statusData.status === 'failed') {
            throw new Error(statusData.error || 'Conversion failed');
          }
          
          attempts++;
        }
        
        throw new Error('Conversion timeout - please try again');
        
      } catch (error) {
        showStatus('error', `Error: ${error.message}`);
        convertBtn.disabled = false;
      }
    };
    
    cancelBtn.onclick = () => {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    };
    
    // Listen for messages from plugin code
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (msg.type === 'import-complete') {
        if (msg.success) {
          showStatus('success', msg.message);
          setTimeout(() => {
            parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
          }, 2000);
        } else {
          showStatus('error', msg.message);
          convertBtn.disabled = false;
        }
      }
    };
    
    function showStatus(type, message) {
      statusDiv.className = `status ${type}`;
      if (type === 'loading') {
        statusDiv.innerHTML = `<span class="spinner"></span>${message}`;
      } else {
        statusDiv.textContent = message;
      }
    }
  </script>
</body>
</html>
